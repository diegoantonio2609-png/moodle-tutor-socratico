import gradio as gr
import requests
import os

API_URL = "https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1"
API_TOKEN = os.environ.get("HF_TOKEN")

def chat(mensaje, historial):
    # Construir contexto
    contexto = ""
    for h in historial:
        contexto += f"Estudiante: {h[0]}\nTutor: {h[1]}\n"
    
    prompt = f"""Eres un tutor socrÃ¡tico. Responde con preguntas reflexivas en espaÃ±ol. MÃ¡ximo 3 oraciones.
{contexto}
Estudiante: {mensaje}
Tutor:"""

    headers = {
        "Authorization": f"Bearer {API_TOKEN}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 120,
            "temperature": 0.7,
            "return_full_text": False
        }
    }
    
    try:
        response = requests.post(API_URL, headers=headers, json=payload, timeout=30)
        
        # Debug: imprimir status
        print(f"Status: {response.status_code}")
        print(f"Response: {response.text[:200]}")
        
        if response.status_code == 503:
            return "El modelo estÃ¡ cargando. Espera 20 segundos e intenta de nuevo."
        
        response.raise_for_status()
        data = response.json()
        
        # Manejar diferentes formatos de respuesta
        if isinstance(data, list) and len(data) > 0:
            if "generated_text" in data[0]:
                return data[0]["generated_text"].strip()
            elif isinstance(data[0], str):
                return data[0].strip()
        
        return f"Respuesta inesperada: {str(data)[:100]}"
        
    except requests.exceptions.Timeout:
        return "Tiempo de espera agotado. Intenta de nuevo."
    except requests.exceptions.RequestException as e:
        return f"Error de red: {str(e)[:100]}"
    except Exception as e:
        return f"Error: {str(e)[:100]}"

demo = gr.ChatInterface(
    fn=chat,
    title="ğŸ“ Tutor SocrÃ¡tico IA",
    description="Haz preguntas y el tutor te guiarÃ¡ mediante el mÃ©todo socrÃ¡tico.",
    examples=["Â¿QuÃ© es la fotosÃ­ntesis?", "Â¿CÃ³mo funciona la gravedad?"],
    retry_btn="ğŸ”„ Reintentar",
    undo_btn="â†©ï¸ Deshacer",
    clear_btn="ğŸ—‘ï¸ Limpiar"
)

demo.launch()
